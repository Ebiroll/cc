<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDX8GX2kBCpb1qFD38jZ3shCIc-SjmdrlI&sensor=false">
    </script>
    <script src="js/jquery.js"></script>
    <script src="js/user.js"></script>

    
    <script src="lib/socket.io.js"></script>
    
    <script type="text/javascript">
        
    var doc = $(document);
    var connects = {};
    var markers = {};
    var socket = io.connect('/');     
    var map;
    

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(positionSuccess, positionError, { enableHighAccuracy: true });
	} else {
		$('.map').text('Your browser is out of fashion, there\'s no geolocation!');
	}

	function positionSuccess(position) {
		var lat = position.coords.latitude;
		var lng = position.coords.longitude;
		var acr = position.coords.accuracy;

		var emit = $.now();
		// send coords on when user is active
		doc.on('mousemove', function() {
			active = true;

			sentData = {
				id: username,
				active: active,
				coords: [{
					lat: lat,
					lng: lng,
					acr: acr
				}]
			};

			if ($.now() - emit > 30) {
				socket.emit('send:coords', sentData);
				emit = $.now();
			}
		});
	}

	doc.bind('mouseup mouseleave', function() {
		active = false;
	});

	// handle geolocation api errors
	function positionError(error) {
		var errors = {
			1: 'Authorization fails', // permission denied
			2: 'Can\'t detect your location', //position unavailable
			3: 'Connection timeout' // timeout
		};
		showError('Error:' + errors[error.code]);
	}

	function showError(msg) {
		info.addClass('error').text(msg);

		doc.click(function() {
			info.removeClass('error');
		});
	}

        
    function setMarker(data) {
           var image = 'assets/user.png';

            for (var i = 0; i < data.coords.length; i++) {
              var myLatlng = new google.maps.LatLng(data.coords[i].lat, data.coords[i].lng);
              var marker = new google.maps.Marker({
                  position: myLatlng,
                  map: map,
                  title:data.id,
                  icon: image
              });
              markers[data.id] = marker;
            }
    }

    
            
    function setChicken(data) {
           var image = 'assets/egg-icon.png';

              var myLatlng = new google.maps.LatLng(data.lat, data.lng);
              var marker = new google.maps.Marker({
                  position: myLatlng,
                  map: map,
                  title:data.lname,
                  icon: image
              });
              markers[data.name] = marker;
            }
    

    
    
        
        socket.on('load:chickens', function(data) {
                console.log("got chickendata",data);
		if (!(data.name in connects)) {
			setChicken(data);
		}

		connects[data.name] = data;
		connects[data.name].updated = $.now(); // shothand for (new Date).getTime()
	});
        
      	socket.on('load:coords', function(data) {
                //console.log("got",data);
		if (!(data.id in connects)) {
			setMarker(data);
		}

		connects[data.id] = data;
		connects[data.id].updated = $.now(); // shothand for (new Date).getTime()
	});
  
        
      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(59.4232389, 17.8295509),
          zoom: 8
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map-canvas"/>
  </body>
</html>
